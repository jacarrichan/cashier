<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gxyj.cashier.mapping.recon.CsrReclnPaymentExceMapper">
	<resultMap id="BaseResultMap" type="com.gxyj.cashier.domain.CsrReclnPaymentExce">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on 2017-08-22. -->
		<id column="row_id" jdbcType="INTEGER" property="rowId" />
		<result column="table_row_id" jdbcType="INTEGER" property="tableRowId" />
		<result column="table_name" jdbcType="VARCHAR" property="tableName" />
		<result column="pay_status" jdbcType="VARCHAR" property="payStatus" />
		<result column="order_status" jdbcType="CHAR" property="orderStatus" />		
		<result column="charge_fee" jdbcType="DECIMAL" property="chargeFee" />
		<result column="currency" jdbcType="VARCHAR" property="currency" />
		<result column="trans_id" jdbcType="VARCHAR" property="transId" />
		<result column="order_no" jdbcType="VARCHAR" property="orderNo" />
		<result column="pay_insti_code" jdbcType="VARCHAR" property="payInstiCode" />
		<result column="pay_chnnl_id" jdbcType="INTEGER" property="payChnnlId" />
		<result column="insti_rsp_time" jdbcType="VARCHAR" property="instiRspTime" />
		<result column="insti_trans_id" jdbcType="VARCHAR" property="instiTransId" />
		<result column="error_info" jdbcType="VARCHAR" property="errorInfo" />
		<result column="recln_date" jdbcType="VARCHAR" property="reclnDate" />
		<result column="order_type" jdbcType="VARCHAR" property="orderType" />
		<result column="channel_id" jdbcType="INTEGER" property="channelId" />
		<result column="channel_code" jdbcType="VARCHAR" property="channelCode" />
		<result column="channel_name" jdbcType="VARCHAR" property="channelName" />
		<result column="recon_status" jdbcType="CHAR" property="reconStatus" />
		<result column="orgin_trans_id" jdbcType="VARCHAR" property="orginTransId" />
		<result column="orgin_order_id" jdbcType="VARCHAR" property="orginOrderId" />
		<result column="created_by" jdbcType="VARCHAR" property="createdBy" />
		<result column="created_date" jdbcType="TIMESTAMP" property="createdDate" />
		<result column="last_updt_by" jdbcType="VARCHAR" property="lastUpdtBy" />
		<result column="last_updt_date" jdbcType="TIMESTAMP" property="lastUpdtDate" />
		<result column="version" jdbcType="TINYINT" property="version" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on 2017-08-22. -->
		row_id, table_row_id, table_name, pay_status,order_status, charge_fee, currency,
		trans_id, order_no,
		pay_insti_code, pay_chnnl_id,insti_rsp_time, insti_trans_id,error_info, recln_date, order_type, channel_id,channel_code,
		channel_name,
		recon_status, orgin_trans_id, orgin_order_id, created_by, created_date,
		last_updt_by,
		last_updt_date, version
	</sql>
	<select id="selectByPrimaryKey" parameterType="java.lang.Integer"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on 2017-08-22. -->
		select
		<include refid="Base_Column_List" />
		from csr_recln_payment_exce
		where row_id = #{rowId,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on 2017-08-22. -->
		delete from csr_recln_payment_exce
		where row_id = #{rowId,jdbcType=INTEGER}
	</delete>
			
	<insert id="insert" parameterType="com.gxyj.cashier.domain.CsrReclnPaymentExce">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on 2017-08-22. -->
		<selectKey keyProperty="rowId" order="AFTER" resultType="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>		
		insert into csr_recln_payment_exce (table_row_id, table_name,
		pay_status,order_status, 
		charge_fee, currency, trans_id,
		order_no, pay_insti_code, pay_chnnl_id,insti_rsp_time,insti_trans_id,
		error_info, recln_date, order_type,
		channel_id,channel_code, channel_name, recon_status,
		orgin_trans_id, orgin_order_id, created_by,
		created_date, last_updt_by, last_updt_date,
		version)
		values (#{tableRowId,jdbcType=INTEGER}, #{tableName,jdbcType=VARCHAR},
		#{payStatus,jdbcType=VARCHAR},#{orderStatus,jdbcType=CHAR},
		#{chargeFee,jdbcType=DECIMAL}, #{currency,jdbcType=VARCHAR}, #{transId,jdbcType=VARCHAR},
		#{orderNo,jdbcType=VARCHAR}, #{payInstiCode,jdbcType=VARCHAR},
		#{payChnnlId,jdbcType=INTEGER},#{instiRspTime,jdbcType=VARCHAR},#{instiTransId,jdbcType=VARCHAR},
		#{errorInfo,jdbcType=VARCHAR}, #{reclnDate,jdbcType=VARCHAR}, #{orderType,jdbcType=VARCHAR},
		#{channelId,jdbcType=INTEGER}, 
		#{channelCode,jdbcType=VARCHAR},
		#{channelName,jdbcType=VARCHAR},
		#{reconStatus,jdbcType=CHAR},
		#{orginTransId,jdbcType=VARCHAR}, #{orginOrderId,jdbcType=VARCHAR}, #{createdBy,jdbcType=VARCHAR},
		#{createdDate,jdbcType=TIMESTAMP}, #{lastUpdtBy,jdbcType=VARCHAR},
		#{lastUpdtDate,jdbcType=TIMESTAMP},
		#{version,jdbcType=TINYINT})
	</insert>
	
	<insert id="insertSelective" parameterType="com.gxyj.cashier.domain.CsrReclnPaymentExce">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on 2017-08-22. -->
		<selectKey keyProperty="rowId" order="AFTER" resultType="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into csr_recln_payment_exce
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="tableRowId != null">
				table_row_id,
			</if>
			<if test="tableName != null">
				table_name,
			</if>
			<if test="payStatus != null">
				pay_status,
			</if>
			<if test="orderStatus != null">
				order_status,
			</if>
			<if test="chargeFee != null">
				charge_fee,
			</if>
			<if test="currency != null">
				currency,
			</if>
			<if test="transId != null">
				trans_id,
			</if>
			<if test="orderNo != null">
				order_no,
			</if>
			<if test="payInstiCode != null">
				pay_insti_code,
			</if>
			<if test="payChnnlId != null">
				pay_chnnl_id,
			</if>
	
			<if test="errorInfo != null">
				error_info,
			</if>
			<if test="reclnDate != null">
				recln_date,
			</if>
			<if test="orderType != null">
				order_type,
			</if>
			<if test="channelId != null">
				channel_id,
			</if>
			<if test="channelCode != null">
				channel_code,
			</if>
			<if test="channelName != null">
				channel_name,
			</if>
			<if test="reconStatus != null">
				recon_status,
			</if>
			<if test="orginTransId != null">
				orgin_trans_id,
			</if>
			<if test="orginOrderId != null">
				orgin_order_id,
			</if>
			<if test="createdBy != null">
				created_by,
			</if>
			<if test="createdDate != null">
				created_date,
			</if>
			<if test="lastUpdtBy != null">
				last_updt_by,
			</if>
			<if test="lastUpdtDate != null">
				last_updt_date,
			</if>
			<if test="version != null">
				version,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="tableRowId != null">
				#{tableRowId,jdbcType=INTEGER},
			</if>
			<if test="tableName != null">
				#{tableName,jdbcType=VARCHAR},
			</if>
			<if test="payStatus != null">
				#{payStatus,jdbcType=VARCHAR},
			</if>
			<if test="orderStatus != null">
				#{orderStatus,jdbcType=CHAR},
			</if>
			<if test="chargeFee != null">
				#{chargeFee,jdbcType=DECIMAL},
			</if>
			<if test="currency != null">
				#{currency,jdbcType=VARCHAR},
			</if>
			<if test="transId != null">
				#{transId,jdbcType=VARCHAR},
			</if>
			<if test="orderNo != null">
				#{orderNo,jdbcType=VARCHAR},
			</if>
			<if test="payInstiCode != null">
				#{payInstiCode,jdbcType=VARCHAR},
			</if>
			<if test="payChnnlId != null">
				#{payChnnlId,jdbcType=INTEGER},
			</if>			
			<if test="instiRspTime != null">
				#{instiRspTime,jdbcType=VARCHAR},
			</if>			
			<if test="instiTransId != null">
				#{instiTransId,jdbcType=VARCHAR},
			</if>
			<if test="errorInfo != null">
				#{errorInfo,jdbcType=VARCHAR},
			</if>
			<if test="reclnDate != null">
				#{reclnDate,jdbcType=VARCHAR},
			</if>
			<if test="orderType != null">
				#{orderType,jdbcType=VARCHAR},
			</if>
			<if test="channelId != null">
				#{channelId,jdbcType=INTEGER},
			</if>
			<if test="channelCode != null">
				#{channelCode,jdbcType=VARCHAR},
			</if>
			<if test="channelName != null">
				#{channelName,jdbcType=VARCHAR},
			</if>
			<if test="reconStatus != null">
				#{reconStatus,jdbcType=CHAR},
			</if>
			<if test="orginTransId != null">
				#{orginTransId,jdbcType=VARCHAR},
			</if>
			<if test="orginOrderId != null">
				#{orginOrderId,jdbcType=VARCHAR},
			</if>
			<if test="createdBy != null">
				#{createdBy,jdbcType=VARCHAR},
			</if>
			<if test="createdDate != null">
				#{createdDate,jdbcType=TIMESTAMP},
			</if>
			<if test="lastUpdtBy != null">
				#{lastUpdtBy,jdbcType=VARCHAR},
			</if>
			<if test="lastUpdtDate != null">
				#{lastUpdtDate,jdbcType=TIMESTAMP},
			</if>
			<if test="version != null">
				#{version,jdbcType=TINYINT},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.gxyj.cashier.domain.CsrReclnPaymentExce">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on 2017-08-22. -->
		update csr_recln_payment_exce
		<set>
			<if test="tableRowId != null">
				table_row_id = #{tableRowId,jdbcType=INTEGER},
			</if>
			<if test="tableName != null">
				table_name = #{tableName,jdbcType=VARCHAR},
			</if>
			<if test="payStatus != null">
				pay_status = #{payStatus,jdbcType=VARCHAR},
			</if>
			<if test="orderStatus != null">
				order_status = #{orderStatus,jdbcType=CHAR},
			</if>
			<if test="chargeFee != null">
				charge_fee = #{chargeFee,jdbcType=DECIMAL},
			</if>
			<if test="currency != null">
				currency = #{currency,jdbcType=VARCHAR},
			</if>
			<if test="transId != null">
				trans_id = #{transId,jdbcType=VARCHAR},
			</if>
			<if test="orderNo != null">
				order_no = #{orderNo,jdbcType=VARCHAR},
			</if>
			<if test="payInstiCode != null">
				pay_insti_code = #{payInstiCode,jdbcType=VARCHAR},
			</if>
			<if test="payChnnlId != null">
				pay_chnnl_id = #{payChnnlId,jdbcType=INTEGER},
			</if>		
						
			<if test="instiRspTime != null">
				insti_rsp_time=#{instiRspTime,jdbcType=VARCHAR},
			</if>
			
			<if test="instiTransId != null">
				insti_trans_id=#{instiTransId,jdbcType=VARCHAR},
			</if>
			
			<if test="errorInfo != null">
				error_info = #{errorInfo,jdbcType=VARCHAR},
			</if>
			<if test="reclnDate != null">
				recln_date = #{reclnDate,jdbcType=VARCHAR},
			</if>
			<if test="orderType != null">
				order_type = #{orderType,jdbcType=VARCHAR},
			</if>
			<if test="channelId != null">
				channel_id = #{channelId,jdbcType=INTEGER},
			</if>
			<if test="channelCode != null">
				channel_code = #{channelCode,jdbcType=VARCHAR},
			</if>
			<if test="channelName != null">
				channel_name = #{channelName,jdbcType=VARCHAR},
			</if>
			<if test="reconStatus != null">
				recon_status = #{reconStatus,jdbcType=CHAR},
			</if>
			<if test="orginTransId != null">
				orgin_trans_id = #{orginTransId,jdbcType=VARCHAR},
			</if>
			<if test="orginOrderId != null">
				orgin_order_id = #{orginOrderId,jdbcType=VARCHAR},
			</if>
			<if test="createdBy != null">
				created_by = #{createdBy,jdbcType=VARCHAR},
			</if>
			<if test="createdDate != null">
				created_date = #{createdDate,jdbcType=TIMESTAMP},
			</if>
			<if test="lastUpdtBy != null">
				last_updt_by = #{lastUpdtBy,jdbcType=VARCHAR},
			</if>
			<if test="lastUpdtDate != null">
				last_updt_date = #{lastUpdtDate,jdbcType=TIMESTAMP},
			</if>
			<if test="version != null">
				version = #{version,jdbcType=TINYINT},
			</if>
		</set>
		where row_id = #{rowId,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.gxyj.cashier.domain.CsrReclnPaymentExce">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on 2017-08-22. -->
		update csr_recln_payment_exce
		set table_row_id = #{tableRowId,jdbcType=INTEGER},
		table_name = #{tableName,jdbcType=VARCHAR},
		pay_status = #{payStatus,jdbcType=VARCHAR},
		order_status = #{orderStatus,jdbcType=CHAR},		
		charge_fee = #{chargeFee,jdbcType=DECIMAL},
		currency = #{currency,jdbcType=VARCHAR},
		trans_id = #{transId,jdbcType=VARCHAR},
		order_no = #{orderNo,jdbcType=VARCHAR},
		pay_insti_code = #{payInstiCode,jdbcType=VARCHAR},
		pay_chnnl_id = #{payChnnlId,jdbcType=INTEGER},
		insti_rsp_time=#{instiRspTime,jdbcType=VARCHAR},
		insti_trans_id=#{instiTransId,jdbcType=VARCHAR},					
		error_info = #{errorInfo,jdbcType=VARCHAR},
		recln_date = #{reclnDate,jdbcType=VARCHAR},
		order_type = #{orderType,jdbcType=VARCHAR},
		channel_id = #{channelId,jdbcType=INTEGER},
		channel_code = #{channelCode,jdbcType=VARCHAR},		
		channel_name = #{channelName,jdbcType=VARCHAR},
		recon_status = #{reconStatus,jdbcType=CHAR},
		orgin_trans_id = #{orginTransId,jdbcType=VARCHAR},
		orgin_order_id = #{orginOrderId,jdbcType=VARCHAR},
		created_by = #{createdBy,jdbcType=VARCHAR},
		created_date = #{createdDate,jdbcType=TIMESTAMP},
		last_updt_by = #{lastUpdtBy,jdbcType=VARCHAR},
		last_updt_date = #{lastUpdtDate,jdbcType=TIMESTAMP},
		version = #{version,jdbcType=TINYINT}
		where row_id = #{rowId,jdbcType=INTEGER}
	</update>
	<!-- 自定义方法 -->
	<delete id="cleanRecnlDataHistory" parameterType="java.util.Map">
		delete from csr_recln_payment_exce where pay_insti_code = #{payInstiCode,jdbcType=VARCHAR}		
		<if test="reclnDate!=null">
			and recln_date = #{reclnDate,jdbcType=VARCHAR}
		</if>
	</delete>

	<insert id="exportExcepBill" parameterType="java.util.Map">
		<selectKey keyProperty="rowId" order="AFTER" resultType="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into csr_recln_payment_exce (table_row_id,
		table_name,
		pay_status,
		order_status,
		charge_fee,
		currency,
		trans_id,
		order_no,
		pay_insti_code,		
		pay_chnnl_id,
		insti_rsp_time,
		insti_trans_id,
		error_info,
		order_type,
		channel_id,
		channel_code,
		channel_name,
		recon_status,
		orgin_trans_id,
		orgin_order_id,
		recln_date,
		created_by,
		created_date,
		last_updt_by,
		last_updt_date,
		version) select aa.*,#{checkDate,jdbcType=VARCHAR},'Sys',now(),'Sys',now(),0
		from
		(SELECT
		t1.row_id,
		'csr_order_info' AS table_name,
		t2.insti_resp_cd AS pay_status,
		t1.proc_state as order_status,
		t1.charge_fee,
		'CNY' AS currency,
		t1.trans_id AS
		trans_id,
		t1.order_id AS order_no,
		t2.payer_insti_no AS pay_insti_code,
		(select t3.row_id from csr_payment_channel t3 where
		t3.channel_code=t2.payer_insti_no) as pay_chnnl_id,
		t2.insti_rsp_time as insti_rsp_time,
		t2.insti_trans_id as insti_trans_id,
		'' AS error_info,
		'0' AS order_type,
		t1.channel_id,
		t1.channel_cd as channel_code,
		(select
		t3.channel_name from csr_busi_channel t3 where
		t3.row_id=t1.channel_id) as channel_name,
		t1.recon_flag AS recon_status,
		'' as orgin_trans_id,
		'' as orgin_order_id
		FROM
		csr_order_info t1
		INNER JOIN csr_payment t2 ON t2.trans_id = t1.trans_id
		WHERE t1.recon_flag ='04'
		and date_format(t1.trans_time, '%Y%m%d') = #{checkDate,jdbcType=VARCHAR}
		AND t2.payer_insti_no = #{channelCode,jdbcType=VARCHAR}
		UNION
		SELECT t1.row_id,
		'csr_refund_order' AS table_name,
		t2.insti_resp_cd AS pay_status,
		t1.proc_state as order_status,
		0.00 AS charge_fee,
		'CNY' AS currency,
		t1.trans_id AS
		trans_id,
		t1.refund_id AS order_no,
		t2.payer_insti_no AS pay_insti_code,
		(select t3.row_id from csr_payment_channel t3 where
		t3.channel_code=t2.payer_insti_no) as pay_chnnl_id,
		t2.insti_rsp_time as insti_rsp_time,
		t2.insti_trans_id as insti_trans_id,
		'' AS error_info,
		'1' AS order_type,
		t1.channel_id,
		t1.channel_cd as channel_code,
		(select
		t3.channel_name from csr_busi_channel t3 where
		t3.row_id=t1.channel_id) as channel_name,
		t1.recon_flag AS
		recon_status,
		t4.trans_id as orgin_trans_id,
		t4.order_id as orgin_order_id
		FROM
		csr_refund_order t1
		INNER JOIN csr_payment t2 ON t2.trans_id = t1.trans_id
		inner join csr_order_info t4 on t4.order_id=t1.orgn_order_id
		where t4.channel_id=t1.channel_id
		and t1.recon_flag ='04'
		and t2.payer_insti_no = #{channelCode,jdbcType=VARCHAR}
		AND date_format(t1.refund_date, '%Y%m%d') = #{checkDate,jdbcType=VARCHAR})aa;
	</insert>

	<insert id="addExceBillRecordBatch" useGeneratedKeys="true"
		parameterType="java.util.List">
		<selectKey keyProperty="rowId" order="AFTER" resultType="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into csr_recln_payment_exce (table_row_id, table_name,
		pay_status,order_status, 
		charge_fee, currency, trans_id,
		order_no, pay_insti_code, pay_chnnl_id,insti_rsp_time,insti_trans_id,
		error_info, recln_date, order_type,
		channel_id,channel_code, channel_name, recon_status,
		orgin_trans_id, orgin_order_id, created_by,
		created_date, last_updt_by, last_updt_date,
		version) values
		<foreach collection="list" item="item" index="index" separator=",">
			(#{item.tableRowId,jdbcType=INTEGER}, #{item.tableName,jdbcType=VARCHAR},
			#{item.payStatus,jdbcType=VARCHAR},#{item.orderStatus,jdbcType=CHAR},
			#{item.chargeFee,jdbcType=DECIMAL}, #{item.currency,jdbcType=VARCHAR}, #{item.transId,jdbcType=VARCHAR},
			#{item.orderNo,jdbcType=VARCHAR}, #{item.payInstiCode,jdbcType=VARCHAR},
			#{item.payChnnlId,jdbcType=INTEGER},#{item.instiRspTime,jdbcType=VARCHAR},#{item.instiTransId,jdbcType=VARCHAR},
			#{item.errorInfo,jdbcType=VARCHAR}, #{item.reclnDate,jdbcType=VARCHAR}, #{item.orderType,jdbcType=VARCHAR},
			#{item.channelId,jdbcType=INTEGER}, 
			#{item.channelCode,jdbcType=VARCHAR},
			#{item.channelName,jdbcType=VARCHAR},
			#{item.reconStatus,jdbcType=CHAR},
			#{item.orginTransId,jdbcType=VARCHAR}, #{item.orginOrderId,jdbcType=VARCHAR}, #{item.createdBy,jdbcType=VARCHAR},
			#{item.createdDate,jdbcType=TIMESTAMP}, #{item.lastUpdtBy,jdbcType=VARCHAR},
			#{item.lastUpdtDate,jdbcType=TIMESTAMP},
			#{item.version,jdbcType=TINYINT})
		</foreach>
	</insert>

	<select id="qryReconResultExceptList" parameterType="com.gxyj.cashier.domain.CsrReclnPaymentExce"
		resultMap="BaseResultMap">
		SELECT a.row_id,a.order_status,a.trans_id, a.order_no,a.channel_name,
		a.error_info,DATE_FORMAT(a.recln_date,'%Y-%m-%d') as recln_date , a.order_type,
		a.recon_status,a.pay_status,
		b.trans_amt as charge_fee, b.channel_id,c.channel_name as pay_insti_code 
		from csr_recln_payment_exce a
		LEFT JOIN csr_order_info b
		on a.trans_id =b.trans_id
		LEFT JOIN csr_payment_channel c on
		a.pay_insti_code=c.channel_code
		where 1=1
		<if test="reclnDate != null and reclnDate !='' ">
			and a.recln_date = #{reclnDate,jdbcType=VARCHAR}
		</if>
		<if test="payInstiCode != null and payInstiCode !='' ">
			and a.pay_insti_code = #{payInstiCode,jdbcType=VARCHAR}
		</if>
		ORDER BY a.recln_date desc
	</select>


	<select id="fetchExceTransList" parameterType="java.util.Map"
		resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from csr_recln_payment_exce
		where recln_date =
		#{reclnDate,jdbcType=VARCHAR}
		<if test="payInstiCode != null and payInstiCode !='' ">
			and pay_insti_code = #{payInstiCode,jdbcType=VARCHAR}
		</if>
	</select>
	
	<select id="queryRecordByTransId" parameterType="java.lang.String" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from csr_recln_payment_exce
		where trans_id=#{transId,jdbcType=VARCHAR}
	</select>
	

</mapper>
